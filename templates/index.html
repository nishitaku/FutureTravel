{% extends "layout.html" %}
{% block content %}
<div class="form">
    <div class="container">
        <p>出発地<input type="text" id="src" value="東京駅"></p>
        <p>目的地<input type="text" id="dst" value="渋谷駅"></p>
        <p>
            <button id="mapping" class="btn btn-primary">地図描画</button>
            <button id="share" class="btn btn-warning">共有</button>
        </p>
        <p id="msg"></p>
        <!--TODO: レスポンシブ対応-->
        <div id="map_canvas" style="width: 500px; height: 300px"></div>
    </div>
</div>
<hr>
<div class="container">
    <p>
        <button id="test_inline" class="btn btn-secondary" onclick="test_inline()">インラインScript</button>
    </p>
    <p>
        <button id="test_external" class="btn btn-secondary" onclick="test_external()">外部Scriptファイル</button>
    </p>
</div>
<hr>
<div class="container">
    <div id="profileinfo">
        <h2>Profile</h2>
        <div id="profilepicturediv">
        </div>
        <table border="1">
            <tr>
                <th>userId</th>
                <td id="useridprofilefield"></td>
            </tr>
            <tr>
                <th>displayName</th>
                <td id="displaynamefield"></td>
            </tr>
            <tr>
                <th>statusMessage</th>
                <td id="statusmessagefield"></td>
            </tr>
        </table>
    </div>

    <div id="liffdata">
        <h2>LIFF Data</h2>
        <table border="1">
            <tr>
                <th>language</th>
                <td id="languagefield"></td>
            </tr>
            <tr>
                <th>context.viewType</th>
                <td id="viewtypefield"></td>
            </tr>
            <tr>
                <th>context.userId</th>
                <td id="useridfield"></td>
            </tr>
            <tr>
                <th>context.utouId</th>
                <td id="utouidfield"></td>
            </tr>
            <tr>
                <th>context.roomId</th>
                <td id="roomidfield"></td>
            </tr>
            <tr>
                <th>context.groupId</th>
                <td id="groupidfield"></td>
            </tr>
        </table>
    </div>
</div>

<!--jquery-->
<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>

<!--Google map api 本番用-->
<script src="https://maps.google.com/maps/api/js?v=3&key=AIzaSyC9akic1UAj-i4X1fWeYBZwFUkMv3MCNSk"></script>

<!-- LIFF SDK-->
<script src="https://d.line-scdn.net/liff/1.0/sdk.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript" src="/static/js/main.js"></script>
<script>
    window.onload = function () {

        // Google mapの初期化
        initialize();

        // init で初期化。基本情報を取得。
        // https://developers.line.me/ja/reference/liff/#initialize-liff-app
        liff.init(function (data) {

            getProfile();
            initializeApp(data);
        });
    }

    // プロファイルの取得と表示
    function getProfile() {
        // https://developers.line.me/ja/reference/liff/#liffgetprofile()
        liff.getProfile().then((profile) => {
            document.getElementById('useridprofilefield').textContent = profile.userId;
            document.getElementById('displaynamefield').textContent = profile.displayName;

            var profilePictureDiv = document.getElementById('profilepicturediv');
            if (profilePictureDiv.firstElementChild) {
                profilePictureDiv.removeChild(profilePictureDiv.firstElementChild);
            }
            var img = document.createElement('img');
            img.src = profile.pictureUrl;
            img.alt = "Profile Picture";
            img.width = 200;
            profilePictureDiv.appendChild(img);

            document.getElementById('statusmessagefield').textContent = profile.statusMessage;
        }).catch(function (error) {
            window.alert("Error getting profile: " + error);
        });
    }

    function initializeApp(data) {
        document.getElementById('languagefield').textContent = data.language;
        document.getElementById('viewtypefield').textContent = data.context.viewType;
        document.getElementById('useridfield').textContent = data.context.userId;
        document.getElementById('utouidfield').textContent = data.context.utouId;
        document.getElementById('roomidfield').textContent = data.context.roomId;
        document.getElementById('groupidfield').textContent = data.context.groupId;
    }

    $('#mapping').click(() => {
        dispRoute();
    });

    $('#share').click(() => {
        console.log('share');
        $.ajax({
            type: 'GET',
            url: '/getimage',
            data: {
                'src': encodeURI($('#src').val()),
                'dst': encodeURI($('#dst').val())
            },
            success: (res, status) => {
                console.log(res);
                liff.getProfile().then((profile) => {
                    liff.sendMessages([
                        {
                            type: 'text',
                            text: res.result
                        },
                        {
                            type: 'image',
                            originalContentUrl: res.map_image_url,
                            previewImageUrl: res.map_image_url_thumbnail
                        }
                    ]).then(() => {
                        liff.closeWindow();
                    }).catch((error) => {
                        window.alert('Error sending message: ' + error.message);
                    });
                }).catch((error) => {
                    window.alert("Error getting profile: " + error.message);
                });
            },
            error: (res) => {
                window.alert('Error saving image: ' + res.status);
            },
            complete: (data) => {
            }
        });
    });

    function test_inline() {
        alert('test');
    }

</script>
{% endblock %}
